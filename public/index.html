<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Usage UI</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-18DJ0TJVR1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-18DJ0TJVR1');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0071e3;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .refresh-btn {
            background: var(--card-bg);
            border: 1px solid #d2d2d7;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .refresh-btn:hover { background: #f2f2f7; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .stat-sub {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e5e5ea;
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }

        .tab {
            padding: 8px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #636366;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: white;
            color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-sm {
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid #d2d2d7;
            background: transparent;
            color: #636366;
        }
        .tab-sm.active {
            background: #0071e3;
            color: white;
            border-color: #0071e3;
        }

        .tier-info {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #86868b;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            text-align: center;
            line-height: 16px;
            cursor: help;
        }

        footer a:hover {
            color: var(--accent-color) !important;
        }

        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(245, 245, 247, 0.9);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 113, 227, 0.2);
            border-radius: 50%;
            border-top-color: #0071e3;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .loading-sub {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        th { color: var(--text-secondary); font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        .cost-positive { color: #ff3b30; font-weight: 600; }
    
        .share-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
            margin-top: 8px;
            text-decoration: none;
        }
        .share-btn:hover { transform: scale(1.05); background: #333; }
</style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing Usage Data...</div>
        <div class="loading-sub">This may take a few minutes on first load</div>
    </div>

    <div class="container" id="dashboard" style="display: none; opacity: 0; transition: opacity 0.5s;">
        <header>
            <div style="display: flex; align-items: baseline; gap: 10px;">
                <h1>Claude Code Usage</h1>
                <span id="appVersion" style="font-size: 12px; color: var(--text-secondary);"></span>
            </div>
            <button class="refresh-btn" onclick="loadData(true)">ðŸ”„ Force Refresh</button>
        </header>

        <div class="stats-grid">
            <div class="card stat-card">
                <h3>Total Cost</h3>
                <div class="stat-value" id="totalCost">$0.00</div>
                <div class="stat-sub">All time estimated</div>
            </div>
            <div class="card stat-card">
                <h3>This Month</h3>
                <div class="stat-value" id="monthCost">$0.00</div>
                <div class="stat-sub" id="monthLabel">Current Month</div>
            </div>
            <div class="card stat-card">
                <h3>Total Tokens</h3>
                <div class="stat-value" id="totalTokens">0M</div>
                <div class="stat-sub">Input + Output + Cache</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h2 style="margin:0; font-size:18px;">Usage Trend</h2>
                            <span class="tier-info" data-tippy-content="ðŸŒ± Starter: <1M<br>âš¡ Pro: 1M+ (Daily User)<br>ðŸ”´ Power: 10M+ (Haiku 4.5 Class)<br>ðŸŸ£ Mega: 50M+ (Sonnet 4.5 Class)<br>ðŸŸ£ Legendary: 100M+ (Opus 4.5 Class)">?</span>
                        </div>
                        
                        <div id="userLevel" style="font-size:12px; color:#0071e3; margin-top:4px; font-weight:500;"></div>
                        <button onclick="shareStats()" class="share-btn">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            Share Stats
                        </button>

                    </div>
                    <div class="tabs">
                        <button class="tab active" onclick="switchMetric('tokens')">Tokens</button>
                        <button class="tab" onclick="switchMetric('cost')">Cost ($)</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px; display:flex; gap:10px; justify-content:flex-end;">
                     <button class="tab-sm active" id="view-daily" onclick="switchView('daily')">Daily</button>
                     <button class="tab-sm" id="view-monthly" onclick="switchView('monthly')">Monthly</button>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 style="margin:0 0 20px 0; font-size:18px;">Model Breakdown (Last 30 Days)</h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="modelChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 20px 0; font-size:18px;">Recent Daily Usage</h2>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Input Tokens</th>
                            <th>Output Tokens</th>
                            <th>Cache Tokens</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; padding: 30px 20px; color: var(--text-secondary); font-size: 13px; border-top: 1px solid #e5e5e7;">
            <div style="margin-bottom: 24px; font-size: 15px;">
                Do you use Claude Code like an employee? <br> 
                <a href="https://crewx.dev" target="_blank" style="color: #0071e3; text-decoration: none; font-weight: 600;">
                    Manage your whole AI team with CrewX â†’
                </a>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 16px;">
                <a href="https://github.com/sowonlabs/ccusage-ui" target="_blank" title="GitHub" style="color: var(--text-secondary); transition: color 0.2s;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                </a>
                <a href="https://x.com/dohapark81" target="_blank" title="X (Twitter)" style="color: var(--text-secondary); transition: color 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
                <a href="https://www.threads.net/@dohapark81" target="_blank" title="Threads" style="color: var(--text-secondary); transition: color 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.17.408-2.274 1.33-3.109.858-.775 2.071-1.263 3.51-1.413 1.044-.11 2.016-.073 2.91.088-.07-.653-.274-1.176-.617-1.58-.457-.539-1.148-.823-2.002-.823h-.082c-.68.013-1.241.209-1.669.583l-1.394-1.54c.78-.705 1.793-1.082 3.02-1.126h.11c1.515 0 2.725.503 3.6 1.494.78.885 1.207 2.084 1.27 3.56.455.155.874.337 1.255.548 1.253.695 2.17 1.678 2.647 2.843.716 1.748.682 4.494-1.433 6.564-1.905 1.865-4.287 2.727-7.492 2.747zm-1.25-9.01c-1.29.137-2.24.49-2.75.962-.41.382-.594.817-.548 1.298.063 1.04 1.09 1.696 2.61 1.613 1.076-.058 1.907-.453 2.47-1.173.496-.634.783-1.503.855-2.592-.846-.153-1.735-.194-2.637-.108z"/></svg>
                </a>
                <a href="https://www.linkedin.com/in/dohapark81/" target="_blank" title="LinkedIn" style="color: var(--text-secondary); transition: color 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                </a>
            </div>
            <a href="https://www.sowonlabs.com" target="_blank" style="color: var(--text-secondary); text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                <img src="https://www.sowonai.com/img/LogoIcon2.png" alt="Sowon Labs" style="height: 20px; width: auto; opacity: 0.7;">
                <span style="opacity: 0.8;">sowonlabs.com</span>
            </a>
        </footer>
    </div>

    <script>
        let dailyData = [];
        let monthlyData = [];
        let trendChart = null;
        let modelChart = null;

        async function loadData(force = false) {
            const loading = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            const statusText = document.querySelector('.loading-text');
            const subText = document.querySelector('.loading-sub');
            
            loading.style.display = 'flex';
            loading.style.opacity = '1';
            dashboard.style.opacity = '0'; // Fade out dashboard while reloading
            
            try {
                statusText.textContent = force ? "Refreshing Data..." : "Analyzing Usage Data...";
                subText.textContent = force ? "This may take a few minutes..." : "This may take a few minutes on first load";
                
                const query = force ? '?force=true' : '';
                
                const [dailyRes, monthlyRes] = await Promise.all([
                    fetch('/api/daily' + query),
                    fetch('/api/monthly' + query)
                ]);

                statusText.textContent = "Processing...";
                
                const dData = await dailyRes.json();
                const mData = await monthlyRes.json();

                // Check cache status from headers for feedback (optional)
                const isCacheHit = dailyRes.headers.get('X-Cache') === 'HIT';
                if(isCacheHit) subText.textContent = "Loaded from 5min cache (Fast!)";
                else subText.textContent = "Fresh data loaded!";

                dailyData = dData.daily || [];
                monthlyData = mData.monthly || [];
                const totals = mData.totals || {};

                renderDashboard(totals);
                
                // Hide loading
                setTimeout(() => {
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                        dashboard.style.display = 'block';
                        setTimeout(() => dashboard.style.opacity = '1', 50);
                    }, 300);
                }, 500); // Slight delay to show "Fresh data" message

            } catch (err) {
                statusText.textContent = "Error Loading Data";
                subText.textContent = "Please check server logs.";
                console.error(err);
            }
        }

        function renderDashboard(totals) {
            // Update Top Stats
            document.getElementById('totalCost').textContent = '$' + (totals.totalCost || 0).toFixed(2);
            document.getElementById('totalTokens').textContent = ((totals.totalTokens || 0) / 1000000).toFixed(1) + 'M';

            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const thisMonthData = monthlyData.find(m => m.month === currentMonth);
            document.getElementById('monthCost').textContent = '$' + (thisMonthData ? thisMonthData.totalCost.toFixed(2) : '0.00');
            document.getElementById('monthLabel').textContent = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });

            // Render Charts
            renderTrendChart();
            renderModelChart();
            renderTable();
        }

        let currentMetric = 'tokens'; // Changed default to 'tokens'
        let currentView = 'daily'; 

        function switchMetric(metric) {
            currentMetric = metric;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Update button states manually
            const btns = document.querySelectorAll('.tabs .tab');
            if(metric === 'tokens') { btns[0].classList.add('active'); btns[1].classList.remove('active'); }
            else { btns[1].classList.add('active'); btns[0].classList.remove('active'); }

            renderTrendChart();
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('view-daily').classList.toggle('active', view === 'daily');
            document.getElementById('view-monthly').classList.toggle('active', view === 'monthly');
            renderTrendChart();
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            const dataSrc = currentView === 'daily'
                ? [...dailyData].sort((a, b) => a.date.localeCompare(b.date)).slice(-30)
                : [...monthlyData].sort((a, b) => a.month.localeCompare(b.month));
            const labels = dataSrc.map(d => currentView === 'daily' ? d.date : d.month);
            
            let datasetData;
            let label;
            let color;
            let annotations = {};

            if (currentMetric === 'cost') {
                datasetData = dataSrc.map(d => d.totalCost);
                label = 'Cost ($)';
                color = '#0071e3';
                document.getElementById('userLevel').textContent = '';
            } else {
                // Tokens in Millions
                datasetData = dataSrc.map(d => (d.totalTokens || (d.inputTokens + d.outputTokens + (d.cacheReadTokens||0) + (d.cacheCreationTokens||0))) / 1000000);
                label = 'Total Tokens (Millions)';
                color = '#34c759';

                // Add Benchmarks
                if (currentMetric === 'tokens') {
                    if (currentView === 'monthly') {
                        // Monthly Benchmarks & Projection
                        const lastDataPoint = dataSrc[dataSrc.length - 1];
                        const lastVal = datasetData[datasetData.length - 1]; // Millions
                        
                        const now = new Date();
                        const currentMonthStr = now.toISOString().slice(0, 7);
                        
                        let displayHTML = "";
                        
                        const getLevelName = (val) => {
                            if (val >= 100) return "ðŸŸ£ Legendary (Opus 4.5 Class)";
                            if (val >= 50) return "ðŸŸ£ Mega (Sonnet 4.5 Class)";
                            if (val >= 10) return "ðŸ”´ Power (Haiku 4.5 Class)";
                            if (val >= 1) return "âš¡ Pro (Daily User)";
                            return "ðŸŒ± Starter";
                        };

                        // Only project if the last data point is the current month
                        if (lastDataPoint && lastDataPoint.month === currentMonthStr) {
                            const day = now.getDate();
                            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                            const projection = (lastVal / day) * daysInMonth;
                            
                            displayHTML = `
                                <div style="display:flex; flex-direction:column; gap:4px; border-left: 3px solid #0071e3; padding-left: 10px;">
                                    <div style="font-size: 14px; color: #1d1d1f; display: flex; align-items: center;">
                                        Current: <b style="color:#0071e3">${getLevelName(lastVal)}</b> <span style="color:#86868b; margin-left: 5px;">(${lastVal.toFixed(1)}M)</span>
                                    </div>
                                    <div style="font-size: 14px; color: #1d1d1f;">
                                        Pace: <b style="color:#5856d6">${getLevelName(projection)}</b> <span style="color:#86868b">(${projection.toFixed(1)}M)</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            displayHTML = `<div>Level: <b>${getLevelName(lastVal)}</b></div>`;
                        }
                        
                        document.getElementById('userLevel').innerHTML = displayHTML;
                    } else {
                        // Daily Benchmarks
                        document.getElementById('userLevel').textContent = 'Daily Pace Benchmarks (Monthly Equivalent)';
                    }
                } else {
                     document.getElementById('userLevel').textContent = '';
                }
            }
            
            const plugins = [
                {
                    id: 'custom_lines',
                    beforeDraw: (chart) => {
                        if (currentMetric === 'tokens') {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            const xAxis = chart.scales.x;
                            
                            const drawLine = (value, color, text) => {
                                const y = yAxis.getPixelForValue(value);
                                if (y <= yAxis.bottom && y >= yAxis.top) {
                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.strokeStyle = color;
                                    ctx.lineWidth = 2;
                                    ctx.setLineDash([5, 5]);
                                    ctx.moveTo(xAxis.left, y);
                                    ctx.lineTo(xAxis.right, y);
                                    ctx.stroke();
                                    
                                    ctx.fillStyle = color;
                                    ctx.font = "bold 11px -apple-system";
                                    ctx.fillText(text, xAxis.left + 5, y - 6);
                                    ctx.restore();
                                }
                            };

                            if (currentView === 'monthly') {
                                drawLine(10, '#ff3b30', 'Power (10M)');
                                drawLine(50, '#af52de', 'Mega (50M)');
                                drawLine(100, '#5856d6', 'Legendary (100M)');
                            } else {
                                // Daily Benchmarks
                                
                                // 1. Tier Thresholds (Lighter, background context)
                                // Legendary (100M/mo -> ~3.3M/day)
                                drawLine(3.3, 'rgba(88, 86, 214, 0.4)', 'Legendary (3.3M)');
                                // Mega (50M/mo -> ~1.6M/day)
                                drawLine(1.6, 'rgba(175, 82, 222, 0.4)', 'Mega (1.6M)');
                                // Power (10M/mo -> ~0.33M/day)
                                drawLine(0.33, 'rgba(255, 59, 48, 0.4)', 'Power (0.33M)');

                                // 2. User Average (Stronger, personal metric)
                                const sum = datasetData.reduce((a, b) => a + b, 0);
                                const avg = sum / datasetData.length;
                                drawLine(avg, '#0071e3', `My Avg (${avg.toFixed(1)}M)`);
                            }
                        }
                    }
                }
            ];

            let datasets = [];
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);

            // Logic for Monthly Token Projection
            if (currentMetric === 'tokens' && currentView === 'monthly') {
                const lastIdx = dataSrc.length - 1;
                const lastData = dataSrc[lastIdx];
                
                // Only if the last bar is the current month
                if (lastData && lastData.month === currentMonthStr) {
                    const day = now.getDate();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    
                    if (day > 0 && day < daysInMonth) {
                        const currentVal = datasetData[lastIdx];
                        const projectedTotal = (currentVal / day) * daysInMonth;
                        const remaining = projectedTotal - currentVal;
                        
                        // Create Projection Dataset (Zeros for past months, value for current)
                        const projectionData = new Array(datasetData.length).fill(0);
                        projectionData[lastIdx] = remaining;

                        datasets = [
                            {
                                label: 'Actual',
                                data: datasetData,
                                backgroundColor: color,
                                borderRadius: 4,
                                stack: 'stack1'
                            },
                            {
                                label: 'Pace',
                                data: projectionData,
                                backgroundColor: 'rgba(52, 199, 89, 0.1)', // Very light green
                                borderColor: '#34c759',
                                borderWidth: 2,
                                borderDash: [5, 5], // Dotted line style
                                borderRadius: 4,
                                stack: 'stack1'
                            }
                        ];
                    }
                }
            }

            // Fallback for standard views
            if (datasets.length === 0) {
                datasets = [{
                    label: label,
                    data: datasetData,
                    backgroundColor: color,
                    borderRadius: 4,
                    hoverBackgroundColor: color
                }];
            }

            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: datasets.length > 1 }, // Show legend if projected
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(1) + (currentMetric === 'cost' ? ' $' : ' M');
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            stacked: true, // Enable stacking
                            grid: { borderDash: [2, 2] },
                            suggestedMax: 10
                        },
                        x: { 
                            grid: { display: false },
                            stacked: true
                        }
                    }
                },
                plugins: plugins
            });
        }

        function renderModelChart() {
            const ctx = document.getElementById('modelChart').getContext('2d');
            if (modelChart) modelChart.destroy();

            // Aggregate costs by model from the last 30 days of daily data
            const modelCosts = {};
            dailyData.slice(-30).forEach(day => {
                if (day.modelBreakdowns) {
                    day.modelBreakdowns.forEach(m => {
                        const name = m.modelName.split('-').slice(0, 2).join(' ');
                        modelCosts[name] = (modelCosts[name] || 0) + m.cost;
                    });
                }
            });

            modelChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(modelCosts),
                    datasets: [{
                        data: Object.values(modelCosts),
                        backgroundColor: ['#5856d6', '#0071e3', '#34c759', '#ff9500', '#ff2d55'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        function renderTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            // Show last 10 days reversed
            const recent = [...dailyData].reverse().slice(0, 10);
            
            recent.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500">${d.date}</td>
                    <td>${(d.inputTokens/1000).toFixed(1)}k</td>
                    <td>${(d.outputTokens/1000).toFixed(1)}k</td>
                    <td>${((d.cacheReadTokens + d.cacheCreationTokens)/1000000).toFixed(2)}M</td>
                    <td class="cost-positive">$${d.totalCost.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        
        function shareStats() {
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);
            const lastData = monthlyData.find(m => m.month === currentMonthStr);
            // Fallback if no monthly data yet
            let lastVal = 0;
            if (lastData) {
                lastVal = (lastData.totalTokens || (lastData.inputTokens + lastData.outputTokens)) / 1000000;
            } else if (dailyData.length > 0) {
                 // Try to sum daily data for this month if monthly api fails or is empty
                 const thisMonthDaily = dailyData.filter(d => d.date.startsWith(currentMonthStr));
                 const sumTokens = thisMonthDaily.reduce((acc, d) => acc + (d.totalTokens || (d.inputTokens + d.outputTokens)), 0);
                 lastVal = sumTokens / 1000000;
            }

            // Simple Projection Logic for 'Pace' if current month
            const day = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            let projected = lastVal;
            if (day > 0) {
                projected = (lastVal / day) * daysInMonth;
            }
            
            const getLevelName = (val) => {
                if (val >= 100) return "Legendary (Opus 4.5 Class)";
                if (val >= 50) return "Mega (Sonnet 4.5 Class)";
                if (val >= 10) return "Power (Haiku 4.5 Class)";
                if (val >= 1) return "Pro (Daily User)";
                return "Starter";
            };
            
            const level = getLevelName(projected);
            const levelId = projected >= 100 ? 'legendary' :
                          projected >= 50 ? 'mega' :
                          projected >= 10 ? 'power' :
                          projected >= 1 ? 'pro' : 'starter';
            
            const shareUrl = `https://sowonlabs.github.io/ccusage-ui/share/${levelId}.html`;

            const text = `I'm a ${level} AI user.
My monthly usage pace is ${projected.toFixed(1)}M tokens.

Check yours:
npx ccusage-ui

Do you use Claude Code like an employee?
Manage your team with @CrewX

#ClaudeCode #CrewX #SowonLabs ${shareUrl}`;
            
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // Initialize tooltips
        tippy('.tier-info', {
            allowHTML: true,
            placement: 'bottom',
            theme: 'light'
        });

        // Load version
        fetch('/api/version')
            .then(r => r.json())
            .then(data => document.getElementById('appVersion').textContent = 'v' + data.version);

        // Start loading
        loadData();
    </script>
</body>
</html>