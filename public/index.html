<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Usage UI</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-18DJ0TJVR1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-18DJ0TJVR1');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0071e3;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .refresh-btn {
            background: var(--card-bg);
            border: 1px solid #d2d2d7;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .refresh-btn:hover { background: #f2f2f7; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .stat-sub {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e5e5ea;
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }

        .tab {
            padding: 8px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #636366;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: white;
            color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-sm {
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid #d2d2d7;
            background: transparent;
            color: #636366;
        }
        .tab-sm.active {
            background: #0071e3;
            color: white;
            border-color: #0071e3;
        }

        .tier-info {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #86868b;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            text-align: center;
            line-height: 16px;
            cursor: help;
        }

        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(245, 245, 247, 0.9);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 113, 227, 0.2);
            border-radius: 50%;
            border-top-color: #0071e3;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .loading-sub {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        th { color: var(--text-secondary); font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        .cost-positive { color: #ff3b30; font-weight: 600; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing Usage Data...</div>
        <div class="loading-sub">Running ccusage CLI</div>
    </div>

    <div class="container" id="dashboard" style="display: none; opacity: 0; transition: opacity 0.5s;">
        <header>
            <div style="display: flex; align-items: baseline; gap: 10px;">
                <h1>Claude Code Usage</h1>
                <span id="appVersion" style="font-size: 12px; color: var(--text-secondary);"></span>
            </div>
            <button class="refresh-btn" onclick="loadData(true)">ðŸ”„ Force Refresh</button>
        </header>

        <div class="stats-grid">
            <div class="card stat-card">
                <h3>Total Cost</h3>
                <div class="stat-value" id="totalCost">$0.00</div>
                <div class="stat-sub">All time estimated</div>
            </div>
            <div class="card stat-card">
                <h3>This Month</h3>
                <div class="stat-value" id="monthCost">$0.00</div>
                <div class="stat-sub" id="monthLabel">Current Month</div>
            </div>
            <div class="card stat-card">
                <h3>Total Tokens</h3>
                <div class="stat-value" id="totalTokens">0M</div>
                <div class="stat-sub">Input + Output + Cache</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h2 style="margin:0; font-size:18px;">Usage Trend</h2>
                            <span class="tier-info" data-tippy-content="ðŸŒ± Starter: ~10M<br>âš¡ Pro: ~100M (Active User)<br>ðŸ”´ Power: ~500M (Tool User)<br>ðŸŸ£ Mega: ~1B (Agent Operator)<br>ðŸŸ£ Legendary: 1B+ (Hive Mind)">?</span>
                        </div>
                        <div id="userLevel" style="font-size:12px; color:#0071e3; margin-top:4px; font-weight:500;"></div>
                    </div>
                    <div class="tabs">
                        <button class="tab active" onclick="switchMetric('tokens')">Tokens</button>
                        <button class="tab" onclick="switchMetric('cost')">Cost ($)</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px; display:flex; gap:10px; justify-content:flex-end;">
                     <button class="tab-sm active" id="view-daily" onclick="switchView('daily')">Daily</button>
                     <button class="tab-sm" id="view-monthly" onclick="switchView('monthly')">Monthly</button>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 style="margin:0 0 20px 0; font-size:18px;">Model Breakdown (Last 30 Days)</h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="modelChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 20px 0; font-size:18px;">Recent Daily Usage</h2>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Input Tokens</th>
                            <th>Output Tokens</th>
                            <th>Cache Tokens</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; padding: 20px; color: var(--text-secondary); font-size: 13px;">
            <a href="https://www.sowonlabs.com" target="_blank" style="color: var(--text-secondary); text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                <img src="https://www.sowonai.com/img/LogoIcon2.png" alt="Sowon Labs" style="height: 24px; width: auto;">
                sowonlabs.com
            </a>
        </footer>
    </div>

    <script>
        let dailyData = [];
        let monthlyData = [];
        let trendChart = null;
        let modelChart = null;

        async function loadData(force = false) {
            const loading = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            const statusText = document.querySelector('.loading-text');
            const subText = document.querySelector('.loading-sub');
            
            loading.style.display = 'flex';
            loading.style.opacity = '1';
            dashboard.style.opacity = '0'; // Fade out dashboard while reloading
            
            try {
                statusText.textContent = force ? "Refreshing Data..." : "Loading Cached Data...";
                subText.textContent = force ? "Ignoring cache, fetching latest logs..." : "Checking for recent updates...";
                
                const query = force ? '?force=true' : '';
                
                const [dailyRes, monthlyRes] = await Promise.all([
                    fetch('/api/daily' + query),
                    fetch('/api/monthly' + query)
                ]);

                statusText.textContent = "Processing...";
                
                const dData = await dailyRes.json();
                const mData = await monthlyRes.json();

                // Check cache status from headers for feedback (optional)
                const isCacheHit = dailyRes.headers.get('X-Cache') === 'HIT';
                if(isCacheHit) subText.textContent = "Loaded from 5min cache (Fast!)";
                else subText.textContent = "Fresh data loaded!";

                dailyData = dData.daily || [];
                monthlyData = mData.monthly || [];
                const totals = mData.totals || {};

                renderDashboard(totals);
                
                // Hide loading
                setTimeout(() => {
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                        dashboard.style.display = 'block';
                        setTimeout(() => dashboard.style.opacity = '1', 50);
                    }, 300);
                }, 500); // Slight delay to show "Fresh data" message

            } catch (err) {
                statusText.textContent = "Error Loading Data";
                subText.textContent = "Please check server logs.";
                console.error(err);
            }
        }

        function renderDashboard(totals) {
            // Update Top Stats
            document.getElementById('totalCost').textContent = '$' + (totals.totalCost || 0).toFixed(2);
            document.getElementById('totalTokens').textContent = ((totals.totalTokens || 0) / 1000000).toFixed(1) + 'M';

            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const thisMonthData = monthlyData.find(m => m.month === currentMonth);
            document.getElementById('monthCost').textContent = '$' + (thisMonthData ? thisMonthData.totalCost.toFixed(2) : '0.00');
            document.getElementById('monthLabel').textContent = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });

            // Render Charts
            renderTrendChart();
            renderModelChart();
            renderTable();
        }

        let currentMetric = 'tokens'; // Changed default to 'tokens'
        let currentView = 'daily'; 

        function switchMetric(metric) {
            currentMetric = metric;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Update button states manually
            const btns = document.querySelectorAll('.tabs .tab');
            if(metric === 'tokens') { btns[0].classList.add('active'); btns[1].classList.remove('active'); }
            else { btns[1].classList.add('active'); btns[0].classList.remove('active'); }

            renderTrendChart();
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('view-daily').classList.toggle('active', view === 'daily');
            document.getElementById('view-monthly').classList.toggle('active', view === 'monthly');
            renderTrendChart();
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            const dataSrc = currentView === 'daily' ? dailyData.slice(-30) : monthlyData;
            const labels = dataSrc.map(d => currentView === 'daily' ? d.date : d.month);
            
            let datasetData;
            let label;
            let color;
            let annotations = {};

            if (currentMetric === 'cost') {
                datasetData = dataSrc.map(d => d.totalCost);
                label = 'Cost ($)';
                color = '#0071e3';
                document.getElementById('userLevel').textContent = '';
            } else {
                // Tokens in Millions
                datasetData = dataSrc.map(d => (d.totalTokens || (d.inputTokens + d.outputTokens + (d.cacheReadTokens||0) + (d.cacheCreationTokens||0))) / 1000000);
                label = 'Total Tokens (Millions)';
                color = '#34c759';

                // Add Benchmarks
                if (currentMetric === 'tokens') {
                    if (currentView === 'monthly') {
                        // Monthly Benchmarks & Projection
                        const lastDataPoint = dataSrc[dataSrc.length - 1];
                        const lastVal = datasetData[datasetData.length - 1]; // Millions
                        
                        const now = new Date();
                        const currentMonthStr = now.toISOString().slice(0, 7);
                        
                        let displayHTML = "";
                        
                        const getLevelName = (val) => {
                            if (val >= 1000) return "ðŸŸ£ Legendary (Hive Mind)";
                            if (val >= 500) return "ðŸŸ£ Mega (Agent Operator)";
                            if (val >= 100) return "ðŸ”´ Power (Tool User)";
                            if (val >= 10) return "âš¡ Pro (Assisted)";
                            return "ðŸŒ± Starter";
                        };

                        // Only project if the last data point is the current month
                        if (lastDataPoint && lastDataPoint.month === currentMonthStr) {
                            const day = now.getDate();
                            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                            const projection = (lastVal / day) * daysInMonth;
                            
                            displayHTML = `
                                <div style="display:flex; flex-direction:column; gap:4px; border-left: 3px solid #0071e3; padding-left: 10px;">
                                    <div style="font-size: 14px; color: #1d1d1f; display: flex; align-items: center;">
                                        Current: <b style="color:#0071e3">${getLevelName(lastVal)}</b> <span style="color:#86868b; margin-left: 5px;">(${lastVal.toFixed(0)}M)</span>
                                    </div>
                                    <div style="font-size: 14px; color: #1d1d1f;">
                                        ðŸš€ Pace: <b style="color:#5856d6">${getLevelName(projection)}</b> <span style="color:#86868b">(${projection.toFixed(0)}M projected)</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            displayHTML = `<div>Level: <b>${getLevelName(lastVal)}</b></div>`;
                        }
                        
                        document.getElementById('userLevel').innerHTML = displayHTML;
                    } else {
                        // Daily Benchmarks
                        document.getElementById('userLevel').textContent = 'Daily Pace Benchmarks (Monthly Equivalent)';
                    }
                } else {
                     document.getElementById('userLevel').textContent = '';
                }
            }
            
            const plugins = [
                {
                    id: 'custom_lines',
                    beforeDraw: (chart) => {
                        if (currentMetric === 'tokens') {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            const xAxis = chart.scales.x;
                            
                            const drawLine = (value, color, text) => {
                                const y = yAxis.getPixelForValue(value);
                                if (y <= yAxis.bottom && y >= yAxis.top) {
                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.strokeStyle = color;
                                    ctx.lineWidth = 2;
                                    ctx.setLineDash([5, 5]);
                                    ctx.moveTo(xAxis.left, y);
                                    ctx.lineTo(xAxis.right, y);
                                    ctx.stroke();
                                    
                                    ctx.fillStyle = color;
                                    ctx.font = "bold 11px -apple-system";
                                    ctx.fillText(text, xAxis.left + 5, y - 6);
                                    ctx.restore();
                                }
                            };

                            if (currentView === 'monthly') {
                                drawLine(100, '#ff3b30', 'Power (100M)');
                                drawLine(500, '#af52de', 'Mega (500M)');
                                drawLine(1000, '#5856d6', 'Legendary (1B)');
                            } else {
                                // Daily Benchmarks
                                
                                // 1. Tier Thresholds (Lighter, background context)
                                // Legendary (1B/mo -> ~33.3M/day)
                                drawLine(33.3, 'rgba(88, 86, 214, 0.4)', 'Legendary (33M)');
                                // Mega (500M/mo -> ~16.6M/day)
                                drawLine(16.6, 'rgba(175, 82, 222, 0.4)', 'Mega (16M)');
                                // Power (100M/mo -> ~3.3M/day)
                                drawLine(3.3, 'rgba(255, 59, 48, 0.4)', 'Power (3.3M)');

                                // 2. User Average (Stronger, personal metric)
                                const sum = datasetData.reduce((a, b) => a + b, 0);
                                const avg = sum / datasetData.length;
                                drawLine(avg, '#0071e3', `My Avg (${avg.toFixed(1)}M)`);
                            }
                        }
                    }
                }
            ];

            let datasets = [];
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);

            // Logic for Monthly Token Projection
            if (currentMetric === 'tokens' && currentView === 'monthly') {
                const lastIdx = dataSrc.length - 1;
                const lastData = dataSrc[lastIdx];
                
                // Only if the last bar is the current month
                if (lastData && lastData.month === currentMonthStr) {
                    const day = now.getDate();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    
                    if (day > 0 && day < daysInMonth) {
                        const currentVal = datasetData[lastIdx];
                        const projectedTotal = (currentVal / day) * daysInMonth;
                        const remaining = projectedTotal - currentVal;
                        
                        // Create Projection Dataset (Zeros for past months, value for current)
                        const projectionData = new Array(datasetData.length).fill(0);
                        projectionData[lastIdx] = remaining;

                        datasets = [
                            {
                                label: 'Actual',
                                data: datasetData,
                                backgroundColor: color,
                                borderRadius: 4,
                                stack: 'stack1'
                            },
                            {
                                label: 'Projected',
                                data: projectionData,
                                backgroundColor: 'rgba(52, 199, 89, 0.1)', // Very light green
                                borderColor: '#34c759',
                                borderWidth: 2,
                                borderDash: [5, 5], // Dotted line style
                                borderRadius: 4,
                                stack: 'stack1'
                            }
                        ];
                    }
                }
            }

            // Fallback for standard views
            if (datasets.length === 0) {
                datasets = [{
                    label: label,
                    data: datasetData,
                    backgroundColor: color,
                    borderRadius: 4,
                    hoverBackgroundColor: color
                }];
            }

            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: datasets.length > 1 }, // Show legend if projected
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(1) + (currentMetric === 'cost' ? ' $' : ' M');
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            stacked: true, // Enable stacking
                            grid: { borderDash: [2, 2] },
                            suggestedMax: 10
                        },
                        x: { 
                            grid: { display: false },
                            stacked: true
                        }
                    }
                },
                plugins: plugins
            });
        }

        function renderModelChart() {
            const ctx = document.getElementById('modelChart').getContext('2d');
            if (modelChart) modelChart.destroy();

            // Aggregate costs by model from the last 30 days of daily data
            const modelCosts = {};
            dailyData.slice(-30).forEach(day => {
                if (day.modelBreakdowns) {
                    day.modelBreakdowns.forEach(m => {
                        const name = m.modelName.split('-').slice(0, 2).join(' ');
                        modelCosts[name] = (modelCosts[name] || 0) + m.cost;
                    });
                }
            });

            modelChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(modelCosts),
                    datasets: [{
                        data: Object.values(modelCosts),
                        backgroundColor: ['#5856d6', '#0071e3', '#34c759', '#ff9500', '#ff2d55'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        function renderTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            // Show last 10 days reversed
            const recent = [...dailyData].reverse().slice(0, 10);
            
            recent.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500">${d.date}</td>
                    <td>${(d.inputTokens/1000).toFixed(1)}k</td>
                    <td>${(d.outputTokens/1000).toFixed(1)}k</td>
                    <td>${((d.cacheReadTokens + d.cacheCreationTokens)/1000000).toFixed(2)}M</td>
                    <td class="cost-positive">$${d.totalCost.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Initialize tooltips
        tippy('.tier-info', {
            allowHTML: true,
            placement: 'bottom',
            theme: 'light'
        });

        // Load version
        fetch('/api/version')
            .then(r => r.json())
            .then(data => document.getElementById('appVersion').textContent = 'v' + data.version);

        // Start loading
        loadData();
    </script>
</body>
</html>